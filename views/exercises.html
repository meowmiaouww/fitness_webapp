<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</title>
</head>
<body>
    <div class="board-container">
        <div class="page-content">
            <main class="main-panel">
                <h1 style="color:var(--color-dark);">–ú–æ–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h1>
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" />
                        <button id="search-exrc-button">
                            <span class="btn-text">–ù–∞–π—Ç–∏</span>
                            <span class="btn-icon" aria-hidden="true">üîç</span>
                        </button>
                        <button id="add-exrc-button">
                            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å</span>
                            <span class="btn-icon" aria-hidden="true">‚ûï</span>
                        </button>
                    </div>
                    <div class="exercise-list">
                    <% if (typeof exercises === 'undefined' || !exercises || exercises.length === 0) { %>
                        <p>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                    <% } else { %>
                        <% exercises.forEach(ex => { %>
                        <div class="exercise-item" data-id="<%= ex.id_exrc %>">
                            <div class="exercise-name"><%= ex.name_exrc %></div>
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                            <button class="delete-exrc-button" aria-label="–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
                            <span class="btn-icon" aria-hidden="true">√ó</span>
                            </button>
                        </div>
                        <% }) %>
                    <% } %>
                    </div>
            </main>
        </div>
        <nav class="bottom-nav">
            <ul class="nav-list">
                <li class="nav-item"><a href="/board">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a></li>
                <li class="nav-item"><a href="/map">–ö–∞—Ä—Ç–∞</a></li>
                <li class="nav-item"><a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
            </ul>
        </nav>
    </div>
<script>
    const addBtn = document.getElementById('add-exrc-button');
    const searchBtn = document.getElementById('search-exrc-button');
    const inputField = document.getElementById('search-input');

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
async function handleDelete(event) {
    const btn = event.currentTarget;
    const item = btn.closest('.exercise-item');
    const name = item.querySelector('.exercise-name').textContent.trim();
    const id   = item.dataset.id;

    if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ¬´${name}¬ª –∏–∑ —Å–ø–∏—Å–∫–∞?`)) {
        return;
    }

    try {
        const res = await fetch('/exercises/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_exrc: id })
        });
        const data = await res.json();
        if (data.success) {
            item.remove();
        } else {
            alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ');
        }
    } catch (err) {
        console.error('Fetch error:', err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
    }
}

// –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´√ó¬ª
function attachDeleteHandlers() {
document.querySelectorAll('.delete-exrc-button').forEach(btn => {
    btn.removeEventListener('click', handleDelete);
    btn.addEventListener('click', handleDelete);
});
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
attachDeleteHandlers();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
addBtn.addEventListener('click', async () => {
    const name = inputField.value.trim();
    if (!name) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
        return;
    }
    try {
        const res = await fetch('/exercises/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name_exrc: name })
        });
        const data = await res.json();

        if (!data.success) {
            alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ');
            return;
        }

        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        inputField.value = '';

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
        const list = document.querySelector('.exercise-list');
        const item = document.createElement('div');
        item.className = 'exercise-item';
        item.dataset.id = data.id;
        item.innerHTML = `
            <div class="exercise-name">${name}</div>
            <button class="delete-exrc-button" aria-label="–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
            <span class="btn-icon" aria-hidden="true">√ó</span>
            </button>
        `;
        list.prepend(item);

        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –Ω–∞ –Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        attachDeleteHandlers();

        } catch (err) {
        console.error('Fetch error:', err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
        }
    });

//–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–π—Ç–∏"
  document.getElementById('search-exrc-button').addEventListener('click', async () => {
    const term = document.getElementById('search-input').value.trim();
    if (!term) {
      alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É –¥–ª—è –ø–æ–∏—Å–∫–∞');
      return;
    }

    let res;
    try {
      res = await fetch(`/exercises/search?term=${encodeURIComponent(term)}`);
    } catch (networkErr) {
      console.error('Network error:', networkErr);
      return alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
    }

    if (!res.ok) {
      // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª 404/500 –∏, –≤–æ–∑–º–æ–∂–Ω–æ, JSON —Å message
      let errData;
      try { errData = await res.json(); } catch (_) {}
      console.error('Server error:', res.status, errData);
      return alert(errData?.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status})`);
    }

    let data;
    try {
      data = await res.json();
    } catch (parseErr) {
      console.error('Invalid JSON:', parseErr);
      return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
    }

    if (!data.success) {
      return alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
    }

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º .exercise-list
    const list = document.querySelector('.exercise-list');
    if (data.exercises.length === 0) {
      list.innerHTML = '<p>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
    } else {
      list.innerHTML = data.exercises.map(ex => `
        <div class="exercise-item" data-id="${ex.id_exrc}">
          <div class="exercise-name">${ex.name_exrc}</div>
          <button class="delete-exrc-button" aria-label="–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
            <span class="btn-icon" aria-hidden="true">√ó</span>
          </button>
        </div>
      `).join('');
    }

    // –ù–∞–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    attachDeleteHandlers();
  });
</script>
</body>
</html>
